<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Horaires de départs SNCF</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Horaires de départs SNCF</h1>

    <input type="text" id="stationInput" placeholder="Rechercher une gare..." />
    <ul id="stationResults"></ul>

    <table id="departuresTable">
      <thead>
        <tr>
          <th>Ligne</th>
          <th>Mission / Train</th>
          <th>Type</th>
          <th>Destination</th>
          <th>Heure</th>
        </tr>
      </thead>
      <tbody id="departuresBody"></tbody>
    </table>
  </div>

  <script>
    const API_KEY = "e41a2be9-7450-4f1a-a7e6-eb429950186f";

    const input = document.getElementById("stationInput");
    const resultsList = document.getElementById("stationResults");
    const tableBody = document.getElementById("departuresBody");

    // === Recherche de gare ===
    input.addEventListener("input", async () => {
      const q = input.value.trim();
      if (q.length < 2) {
        resultsList.innerHTML = "";
        return;
      }

      const url = `https://api.sncf.com/v1/coverage/sncf/places?q=${encodeURIComponent(q)}&type[]=stop_area&count=50`;

      const res = await fetch(url, {
        headers: { Authorization: "Basic " + btoa(API_KEY + ":") },
      });
      const data = await res.json();
      resultsList.innerHTML = "";

      if (!data.places) return;

      data.places.forEach((p) => {
        const li = document.createElement("li");
        li.textContent = p.name;
        li.onclick = () => {
          input.value = p.name;
          resultsList.innerHTML = "";
          loadDepartures(p.id);
        };
        resultsList.appendChild(li);
      });
    });

    // === Chargement des départs ===
    async function loadDepartures(stopAreaId) {
      const url = `https://api.sncf.com/v1/coverage/sncf/stop_areas/${stopAreaId}/departures?count=50`;
      const res = await fetch(url, {
        headers: { Authorization: "Basic " + btoa(API_KEY + ":") },
      });
      const data = await res.json();

      tableBody.innerHTML = "";

      if (!data.departures || data.departures.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" style="text-align:center;">Aucun départ trouvé</td>`;
        tableBody.appendChild(tr);
        return;
      }

      data.departures.forEach((d) => {
        const tr = document.createElement("tr");
        const display = d.display_informations;
        const stopDate = d.stop_date_time;

        const lineCode = display.code || "";
        const mission = display.mission || display.headsign || "";
        const type = display.commercial_mode || "";
        const destination = display.direction || "";
        const baseTime = stopDate.base_departure_date_time;
        const realTime = stopDate.departure_date_time;
        const cancelled = stopDate.status === "cancelled";

        const baseH = baseTime ? formatTime(baseTime) : "";
        const realH = realTime ? formatTime(realTime) : "";

        // === Cellules ===
        const trClass = cancelled ? "cancelled" : "";

        const logo = getLogo(type);
        const terRegion = display.network?.replace("TER ", "") || "";

        let timeCell = "";
        if (cancelled) {
          timeCell = `<span class="cancelled-time">${baseH}</span> <span class="supprime">supprimé</span>`;
        } else if (baseH !== realH) {
          timeCell = `<span class="old-time">${baseH}</span> <span class="new-time">${realH}</span>`;
        } else {
          timeCell = realH;
        }

        tr.innerHTML = `
          <td>${lineCode}</td>
          <td>${mission}</td>
          <td class="type-cell">${logo}${terRegion ? " " + terRegion : ""}</td>
          <td class="${trClass}">${destination}</td>
          <td class="${trClass}">${timeCell}</td>
        `;

        tableBody.appendChild(tr);
      });
    }

    // === Formatage de l'heure ===
    function formatTime(str) {
      const h = str.slice(9, 11);
      const m = str.slice(11, 13);
      return `${h}:${m}`;
    }

    // === Attribution du logo ===
    function getLogo(type) {
      const map = {
        "TER": "ter.svg",
        "Transilien": "transilien.svg",
        "RER": "rer.svg",
        "Intercités": "intercite.svg",
        "TGV INOUI": "inoui.svg",
        "OUIGO": "ouigo.svg"
      };
      const file = map[type] || "";
      return file ? `<img src="logo/${file}" class="train-logo" alt="${type}">` : type;
    }
  </script>
</body>
</html>
